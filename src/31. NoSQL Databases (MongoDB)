# #31. NoSQL Databases (MongoDB)

### Introduction to MongoDB, document databases, data modeling, and basic operations.

- SQL vs. NoSQL
    - **RDBMS** **normalizes** data and stores it in different tables, then combines these pieces using `JOIN`. **Data Integrity (ACID)** is a priority.
    - **MongoDB** **denormalizes** data and stores it in a single document. This allows you to retrieve all the necessary information with a single query. **Flexibility** and **Scalability** are a priority.

    This explains why MongoDB is ideal for faster development and large, variable data.

- What is NoSQL
    - **NoSQL** stands for "Not Only SQL." It refers to databases that provide flexible schemas, horizontal scaling, and are designed for distributed data storage.
    - NoSQL databases are particularly well-suited for handling large volumes of data and real-time web applications.
- Why MongoDB
    - **MongoDB** is one of the most popular NoSQL databases.
    - It stores data in a flexible, JSON-like format called BSON.
    - Benefits:
        - High performance and scalability
        - Flexible schema design
        - Easy to integrate with modern programming languages and frameworks (including Java/Spring)
- Document Databases
    - **Documents**: Data is stored in documents (similar to JSON objects) that can have nested fields.
    - **Collections**: Documents are grouped into collections, analogous to tables in relational databases.
    - **Schema Flexibility**: Each document in a collection can have a different structure.
- Advantages over Relational Databases
    - **Flexibility**: You don't have to define a fixed schema.
    - **Scalability**: Horizontal scaling is easier and more cost-effective.
    - **Performance**: Optimized for high read/write throughput in distributed systems.
- MongoDB Architecture

    Core Components

    - **Databases**: A database contains collections of documents.
    - **Collections**: Similar to tables, they group documents together.
    - **Documents**: The basic unit of data in MongoDB, stored in BSON format.
    - **Indexes**: Improve the performance of read operations.
    - **Replication & Sharding**:
        - **Replication**: For high availability, MongoDB can replicate data across multiple servers.
        - **Sharding**: For horizontal scaling, data is partitioned across different machines.
- MongoDB Shell
    - Use the MongoDB shell (`mongosh`) for command-line interaction.
    - Basic commands include:
        - `show dbs`
        - `use <database>`
        - `show collections`
- Data Modeling in MongoDB
    - **Denormalization**: Embed related data within a single document to avoid joins.
    - **Normalization**: In some cases, reference related documents to reduce data duplication.
    - **Data Access Patterns**: Model your data based on how your application accesses it.
    - **Embedding vs. Referencing**:
        - **Embedding**: Good for one-to-few relationships.
        - **Referencing**: Suitable for one-to-many or many-to-many relationships.
    - Example

        ![image.png](attachment:6d088940-0343-43e5-affa-73490e914bdb:image.png)

- Embedded Documents

    **Embedded Document** means that data that belongs to a data object but would traditionally be stored in a separate table (e.g. address, comment, order details) is stored **directly within (inside)** the main document.

    This is called **Denormalization** (grouping data together) as opposed to **Normalization** (breaking up data to prevent duplication) in Relational DB.

    - Example:

        ![image.png](attachment:904d5c1b-1eed-4d69-9ae5-9522695b0fc7:image.png)

        ![image.png](attachment:79ac350d-239d-4878-92dc-c2b4dab34660:image.png)

- Basic Operations (CRUD) with MongoDB
    - Create (Insert)
        - **Single Document Insert**:

            ![image.png](attachment:281860cd-959b-4672-8a7a-bb0a45658c45:image.png)

        - **Multiple Documents Insert**:

            ![image.png](attachment:d6eb9190-d217-40f9-aed8-7cc89889332c:image.png)

    - Read (Query)
        - **Find All Documents**: db.users.find();
        - **Find with Filter**: db.users.find({ age: { $gte: 30 } });
    - Update
        - **Update a Single  and multiple Document**:


            ![image.png](attachment:e2b3c83f-8389-4fd8-99cf-4b290efa0f82:image.png)

            ![image.png](attachment:8ca8dbae-7673-4d03-b99b-fd5b64f2dbe6:image.png)

    - Delete
        - **Delete a Single Document**:

            ![image.png](attachment:ddf6981b-df95-4e1f-9931-e267acaa4765:image.png)

        - **Delete Multiple Documents**:

            ![image.png](attachment:79f1e3d8-6fa6-4a21-868c-c62dd24c9b5d:image.png)

- Integrating MongoDB with Java/Spring
    - **Dependency Management**: Add the Spring Data MongoDB dependency to your `pom.xml` or `build.gradle`.

        ```xml
        implementation("org.springframework.boot:spring-boot-starter-data-mongodb:3.4.4")
        ```

    - **Configuration**: Configure the connection in your `application.properties`:

        spring.data.mongodb.uri=mongodb://localhost:27017/your-database

    - **Repository Pattern**: Create repository interfaces to handle CRUD operations.

        ![image.png](attachment:a28860d7-4810-45f8-a1bb-839932ccf540:image.png)


### Mentor Notes:

Different from SQL, NoSQL store data not table-based, but related in some ways: **Document, Key-Value (**Redis**), Graph (**nodes, edges**), Column-Family (**Cassandra**)**

- Basic MongoDB Shell Commands

    ![image.png](attachment:40688258-a022-429e-b503-576c5d99f9a6:image.png)

    | **Çoxlu Yazmaq** | `db.users.insertMany([{name: "A", age: 20}, {name: "B", age: 30}])` |
    | --- | --- |
- Comparison of the Terms Relational DB (SQL) and MongoDB


    | **Verilənlər Bazası** (`Database`) | **Verilənlər Bazası** (`Database`) |
    | --- | --- |
    | **Cədvəl** (`Table`) | **Kolleksiya** (`Collection`) |
    | **Sətir** (`Row` / Qeyd) | **Sənəd** (`Document`) |
    | **Sütun** (`Column` / Sahə) | **Sahə** (`Field` / Açar-Dəyər Cütü) |
    | **İndeks** (`Index`) | **İndeks** (`Index`) |
    | **Əlaqə (`JOIN`)** | **Gömülmüş Sənədlər** (`Embedded Documents`) və ya **$lookup** |
    | **İlkin Açar (`Primary Key`)** | **`_id` Sahəsi** |
    | **Sxem (`Schema`)** | **Sxemsiz (`Schema-less`)** |
- `regex` examples

    ![image.png](attachment:b5785265-baf6-451a-b507-f345f841d7a4:image.png)

- Addition: Creating Query Methods

    The most powerful aspect of using `MongoRepository` is that in addition to these ready-made methods, you can have Spring Data automatically generate queries for you by simply typing the method name correctly.

    | Metodun Adı | Sorğu Məntiqi |
    | --- | --- |
    | `findByAge(int age)` | Yaşı verilən rəqəmə **bərabər** olanları tap. |
    | `findByNameAndAge(String name, int age)` | Adı və yaşı verilən şərtə uyğun olanları tap. |
    | `findByAgeGreaterThan(int age)` | Yaşı verilən rəqəmdən **böyük** olanları tap. |
    | `findByStatusOrderByAgeDesc(String status)` | Statusu verilən dəyərə bərabər olanları tap və onları yaşa görə **azalan** (descending) qaydada sırala. |
    | `findByNameStartingWith(String prefix)` | Adı verilən hərflə **başlayanları** tap (Regex istifadə edir). |
- How to apply on Spring
    - model

        Collectiona cixartmaq istediyimiz classa:

        Instead of @Entity, we write: @Document(collection=””)

        No need @GeneratedType…id only @Id is enough

    - repository

        extend from MongoRepository

    - build.gradle

        implementation 'org.springframework.boot:spring-boot-starter-data-mongodb’

    - application.yml

        server:
        port: 8081

        spring:
        data:
        mongodb:
        uri: mongodb://localhost:27017/survey_db

- Id

    mix of digits and letters:

    - **Timestamp (4 bytes):** A timestamp indicating when the document was created.
    - **Machine ID (3 bytes):** The identifier of the computer (server) on which the document was created.
    - **Process ID (2 bytes):** The identifier of the process on that computer that created the Object.
    - **Counter (3 bytes):** A counter to distinguish it from other documents created by the same process.